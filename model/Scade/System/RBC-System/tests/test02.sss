#     Project: openETCS
#      Module: RBC-System / tests
# Description: test02 - successful initiation of session (ยง 3.5.3.7)
source lib.tcl
source const.tcl

puts "running test02"

set NID_ENGINE 4321

# 0) -- (check initial values)
rbc_check_TrainData [list nid_engine 0]
rbc_check_PosData [list nid_lrbg 0]
rbc_check_OutMsg_None
SSM::cycle


# 1) train initiates communication
# in: MSG 155
# out: MSG 32
rbc_set_InMsg_155 2.0 $NID_ENGINE

rbc_check_TrainData [list nid_engine $NID_ENGINE]
rbc_check_PosData [list nid_lrbg $::const::NID_LRBG_UNKNOWN]
rbc_check_OutMsg_32
SSM::cycle

rbc_set_InMsg_None
rbc_check_OutMsg_None 3
SSM::cycle 3

# 5) train responds to MSG 32 with MSG 159 (Session established)
# in: MSG 159
rbc_set_InMsg_159 2.8 $NID_ENGINE

SSM::cycle
puts [rbc_get_OutMsgHeader]
SSM::cycle
puts [rbc_get_OutMsgHeader]
